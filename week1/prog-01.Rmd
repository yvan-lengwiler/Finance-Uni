#!/usr/bin/env KnitWrapper.sh

---
title: "**Inspecting stochastic properties of an equity**"
author: "Yvan Lengwiler"
date: "2025-09-04"
output:
    pdf_document: default
    word_document: default
    html_document: default
---

This script downloads some stock market data from finance.yahoo.com and performs a few simple analyses.

```{r setup, include=FALSE}
# install and load some packages if they are missing
packages <- c('rmarkdown','yfR','scales','here','curl') 
missing <- setdiff(packages, rownames(installed.packages(lib.loc = .libPaths())))
if (length(missing)) install.packages(missing, lib = .libPaths()[1])
invisible(lapply(packages, require, character.only = TRUE))

#if (TRUE) {
#    install.packages('rmarkdown','yfR','scales','here','curl')
#}

# select location of this file as working directory
setwd(here())
```

# 1 Parameters

We begin by setting some parameters. These parameters will determine what the script does exactly.

```{r, set parameters, echo=FALSE}
#symbol    <- 'AMD'              # Advanced Micro Devices
#symbol    <- 'GOOG'             # Alphabet
#symbol    <- 'NESN.SW'          # NestlÃ©
#symbol    <- 'GM'               # General Motors
#symbol    <- 'MSFT'             # Microsoft
#symbol    <- 'PM'               # Philip Morris
#symbol    <- 'XOM'              # Exxon Mobil
#symbol    <- 'UBS'              # UBS
symbol    <- '^GSPC'            # S&P500 index
#symbol    <- 'BTC-USD'          # BTC in USD
#symbol    <- 'CHFUSD=X'         # CHF-USD FX

frequency  <- 'monthly'           # daily, weekly, monthly
#frequency  <- 'daily'           # daily, weekly, monthly

from_date <- '2010-12-01'
to_date   <- '2025-08-31'

cat('Symbol   :', symbol)
cat('Interval : from', from_date, 'to', to_date)
cat('Frequency:', frequency)
```

# 2 Acquire data

We now download the relevant data from `https://finance.yahoo.com`. We use the `yfR` library for this.

```{r, download data}
data <- yf_get(
    tickers = symbol,
    first_date = from_date,
    last_date = to_date,
    freq_data = frequency,
    do_cache = TRUE,
    be_quiet = TRUE
)
price <- as.numeric(data$price_adjusted)
dates <- as.Date(data$ref_date)
```

# 3 Take a look at the data

Let us plot the data ...

```{r, plot price level, echo=FALSE}
plot(dates, log(price), main = symbol, type='l', axes = FALSE)
axis.Date(1, dates, at = seq(dates[1], dates[length(dates)], "years"))
axis(2)
```

... and the yields ...

```{r, compute and plot yields, echo=FALSE}
# annualized return rate from one observation to the next
factor <- switch(
    frequency,
        'monthly' = 12,          # number of trading months
        'weekly'  = 365.25/7,    # number of trading weeks
        'daily'   = 365.25*5/7   # number of trading days
    )
yield <- diff(log(price)) * factor
# plot it
bullet_size <- sqrt(150/length(yield))
plot(dates[-1], yield, 
     main = paste("annualized", frequency, "return of", symbol),
     pch=20, cex=bullet_size, axes = FALSE)
axis.Date(1, dates[-1], at = seq(dates[2], dates[length(dates)], "years"))
axis(2)
```

# 4 Analyse the distribution of the yields

Here is where you should complete the program.
Compute the kernel estimate and plot it.
Then create a Q-Q plot to compare the distribution with the normal distributi
on.

